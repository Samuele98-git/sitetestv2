<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SOES S.p.A.</title>
    <meta name="description" content="SOES S.p.A.">
    <meta name="keywords" content="">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/app.js"></script>
    <style>body { font-family: 'Inter', sans-serif; background: #f8fafc; }</style>
</head>
<body class="flex flex-col min-h-screen pt-24">
    <div id="header-inject"></div>

    <main id="page-content" class="flex-grow animate-fade-in">
        <div class="flex justify-center items-center h-96"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#004080]"></div></div>
    </main>

    <div id="footer-inject"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('p');
        const pwd = urlParams.get('pwd');

        if(slug) {
            const api = pwd ? `/api/pages/${slug}?pwd=${pwd}` : `/api/pages/${slug}`;
            
            fetch(api).then(r => r.ok ? r.json() : Promise.reject(r)).then(page => {
                // 1. SET SEO
                document.title = page.title + " | SOES";
                if(page.meta_desc) document.querySelector('meta[name="description"]').setAttribute("content", page.meta_desc);
                if(page.meta_keywords) document.querySelector('meta[name="keywords"]').setAttribute("content", page.meta_keywords);

                // 2. CHECK PASSWORD
                if(page.is_protected) {
                    renderPasswordForm(slug);
                    return;
                }

                // 3. RENDER BLOCKS WITH ANIMATION
                let html = '';
                
                // Helper to add animation class
                const getAnim = (b) => b.animation ? `anim-box anim-${b.animation}` : '';

                page.blocks.forEach(b => {
                    const animClass = getAnim(b);

                    if(b.type === 'hero') {
                        html += `<div class="relative h-[50vh] flex items-center justify-center text-center text-white bg-cover bg-center ${animClass}" style="background-image: url('${b.image || 'https://placehold.co/1920x600'}');">
                            <div class="absolute inset-0 bg-black/60"></div>
                            <div class="relative z-10 px-4"><h1 class="text-5xl font-extrabold mb-4">${b.title}</h1><p class="text-xl text-gray-200">${b.text}</p></div></div>`;
                    } else if(b.type === 'text') {
                        html += `<div class="max-w-4xl mx-auto px-4 py-16 prose lg:prose-xl text-gray-700 ${animClass}">${b.content}</div>`;
                    } else if(b.type === 'text_image') {
                        html += `<div class="max-w-7xl mx-auto px-4 py-16 grid md:grid-cols-2 gap-12 items-center ${animClass}">
                            <div class="${b.image_right ? 'order-1 md:order-2' : ''}"><img src="${b.image}" class="rounded-3xl shadow-xl w-full"></div>
                            <div class="${b.image_right ? 'order-2 md:order-1' : ''} prose lg:prose-xl text-gray-700">${b.content}</div>
                        </div>`;
                    } else if(b.type === 'image') {
                        html += `<div class="max-w-7xl mx-auto px-4 py-12 ${animClass}"><img src="${b.url}" class="w-full rounded-2xl shadow-xl"></div>`;
                    } else if(b.type === 'cards') {
                        html += `<div class="bg-gray-50 py-16 ${animClass}"><div class="max-w-7xl mx-auto px-4 grid md:grid-cols-3 gap-8">${b.items.map(i => 
                            `<div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-xl font-bold text-[#004080] mb-2">${i.title}</h3><p class="text-gray-600">${i.text}</p></div>`).join('')}</div></div>`;
                    } else if(b.type === 'pdf') {
                        html += `<div class="max-w-4xl mx-auto px-4 py-8 ${animClass}"><a href="${b.url}" target="_blank" class="flex items-center gap-4 bg-white border border-gray-200 p-6 rounded-xl hover:shadow-lg transition group">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-500 text-xl"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg></div>
                            <div><h4 class="font-bold text-lg text-gray-800 group-hover:text-[#004080]">${b.label || 'Scarica Documento'}</h4><p class="text-sm text-gray-500">${b.desc || 'Formato PDF'}</p></div>
                            <div class="ml-auto bg-gray-100 px-4 py-2 rounded text-xs font-bold uppercase text-gray-600 group-hover:bg-[#004080] group-hover:text-white transition">Download</div>
                        </a></div>`;
                    } else if(b.type === 'cv_form') {
                        html += `<div class="${animClass}">` + renderCvForm() + `</div>`;
                    }
                });
                document.getElementById('page-content').innerHTML = html;
                
                // Trigger Animations (defined in app.js)
                if(typeof initAnimations === 'function') initAnimations();

            }).catch((err) => {
                document.getElementById('page-content').innerHTML = `
                <div class="min-h-[60vh] flex flex-col items-center justify-center text-center p-8">
                    <h1 class="text-6xl font-extrabold text-gray-200 mb-4">404</h1>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">Pagina non disponibile</h2>
                    <p class="text-gray-500">La pagina che cerchi non esiste, è scaduta o protetta.</p>
                    <a href="/" class="mt-8 bg-[#004080] text-white px-6 py-2 rounded-full font-bold hover:bg-blue-900 transition">Torna alla Home</a>
                </div>`;
            });
        }

        function renderPasswordForm(slug) {
            document.getElementById('page-content').innerHTML = `
            <div class="min-h-[60vh] flex flex-col items-center justify-center p-4">
                <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                    <i class="fas fa-lock text-4xl text-[#004080] mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">Area Protetta</h2>
                    <p class="text-gray-500 mb-6">Questa pagina è accessibile solo ai collaboratori autorizzati.</p>
                    <form onsubmit="event.preventDefault(); window.location.href='/dynamic.html?p=${slug}&pwd='+document.getElementById('pwd').value">
                        <input type="password" id="pwd" class="w-full border p-3 rounded-lg mb-4 text-center" placeholder="Inserisci Password" required>
                        <button class="w-full bg-[#004080] text-white font-bold py-3 rounded-lg hover:bg-blue-900">Accedi</button>
                    </form>
                </div>
            </div>`;
        }
        
        function renderCvForm() {
             return `<div class="max-w-4xl mx-auto px-4 py-16"><div class="bg-white p-10 rounded-3xl shadow-xl border border-gray-100"><h3 class="text-2xl font-bold text-[#004080] mb-2 text-center">Candidatura Online</h3><p class="text-center text-gray-500 mb-8">Compila tutti i campi obbligatori per inviare la tua domanda.</p><form onsubmit="submitCv(event)" class="space-y-5"><div class="grid grid-cols-1 md:grid-cols-2 gap-5"><input type="text" name="name" placeholder="Nome *" required class="bg-gray-50 border p-3 rounded-lg"><input type="text" name="surname" placeholder="Cognome *" required class="bg-gray-50 border p-3 rounded-lg"><input type="text" name="tax_code" placeholder="Codice Fiscale *" required class="bg-gray-50 border p-3 rounded-lg font-mono uppercase"><input type="text" name="birth_place" placeholder="Luogo di Nascita" class="bg-gray-50 border p-3 rounded-lg"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-5"><input type="text" name="address" placeholder="Indirizzo" class="bg-gray-50 border p-3 rounded-lg"><div class="flex gap-2"><input type="text" name="city" placeholder="Città" class="w-2/3 bg-gray-50 border p-3 rounded-lg"><input type="text" name="zip_code" placeholder="CAP" class="w-1/3 bg-gray-50 border p-3 rounded-lg"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-5"><input type="email" name="email" placeholder="Email *" required class="bg-gray-50 border p-3 rounded-lg"><input type="tel" name="phone" placeholder="Telefono" class="bg-gray-50 border p-3 rounded-lg"></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-50 transition relative group"><input type="file" name="file" accept="application/pdf" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"><div class="group-hover:scale-105 transition transform"><i class="fas fa-cloud-upload-alt text-4xl text-[#004080] mb-2"></i><p class="font-bold text-gray-700">Trascina qui il tuo CV o clicca per caricare</p><p class="text-xs text-gray-400 mt-1">Solo file PDF (Max 5MB)</p></div></div><div id="cv-msg" class="hidden p-4 rounded-lg text-center text-sm font-bold"></div><button type="submit" class="w-full bg-[#004080] text-white font-bold py-4 rounded-xl hover:bg-blue-900 transition shadow-lg">Invia Candidatura Ufficiale</button></form></div></div>`;
        }

        async function submitCv(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button');
            const msg = document.getElementById('cv-msg');
            const fd = new FormData(form);
            fd.append('page_slug', new URLSearchParams(window.location.search).get('p'));

            btn.disabled = true; btn.innerText = 'Elaborazione in corso...';
            msg.className = 'hidden';

            try {
                const res = await fetch('/api/cv', { method: 'POST', body: fd });
                const d = await res.json();
                if(res.ok) {
                    msg.className = 'block p-4 rounded-lg text-center text-sm font-bold bg-green-100 text-green-700 border border-green-200';
                    msg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Candidatura registrata con successo!';
                    form.reset();
                } else {
                    throw new Error(d.error || 'Errore');
                }
            } catch(err) {
                msg.className = 'block p-4 rounded-lg text-center text-sm font-bold bg-red-100 text-red-700 border border-red-200';
                msg.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>' + err.message;
            } finally {
                btn.disabled = false; btn.innerText = 'Invia Candidatura Ufficiale';
            }
        }
    </script>
</body>
</html>